#!/usr/bin/env bash
# kustb - A wrapper script for kustomize build with Helm support
#
# This script provides a convenient wrapper around the kustomize build command
# with pre-configured flags for Helm integration and unrestricted file loading.
#
# Features:
#   - Enables Helm chart processing within kustomize
#   - Removes load restrictions for flexibility in resource loading
#
# Usage:
#   kustb [kustomize-build-options] [directory]
#
# Example:
#   kustb ./overlays/production
#   kustb --output manifest.yaml ./base
#
# Flags enabled by default:
#   --enable-helm            : Allow kustomize to process Helm charts
#   --load-restrictor LoadRestrictionsNone : Disable file loading restrictions
#
# Note: All additional arguments are passed directly to kustomize build
set -euo pipefail

# Detect kustomize binary (allow override via env var)
KUSTOMIZE_BIN="${KUSTOMIZE_BIN:-$(command -v kustomize || true)}"
if [[ -z "$KUSTOMIZE_BIN" ]]; then
	echo "ERROR: kustomize not found in PATH; install kustomize or set KUSTOMIZE_BIN." >&2
	exit 2
fi

# If user asked for help/version, passthrough to kustomize directly
case "${1:-}" in
	-h|--help|--version)
		exec "$KUSTOMIZE_BIN" "$@"
		;;
esac

# If user explicitly provided 'build' as first arg, forward directly
if [[ "${1:-}" == "build" ]]; then
	# Collect args and handle -o/--output and --apply/-apl
	ARGS=()
	OUTPUT_FILE=""
	APPLY=""
	while [[ $# -gt 0 ]]; do
		case "$1" in
			-o)
				if [[ $# -lt 2 ]]; then
					echo "ERROR: -o requires an argument" >&2
					exit 2
				fi
				OUTPUT_FILE="$2"
				shift 2 ;;
			-o*)
				OUTPUT_FILE="${1#-o}"
				shift ;;
			--output)
				if [[ $# -lt 2 ]]; then
					echo "ERROR: --output requires an argument" >&2
					exit 2
				fi
				OUTPUT_FILE="$2"
				shift 2 ;;
			--output=*)
				OUTPUT_FILE="${1#--output=}"
				shift ;;
			--apply|-apl)
				APPLY=1; shift ;;
			*)
				ARGS+=("$1")
				shift ;;
		esac
	done

	if [[ -n "$OUTPUT_FILE" ]]; then
		# run kustomize and write stdout to the output file
		set +e
		"$KUSTOMIZE_BIN" "${ARGS[@]}" | tee "$OUTPUT_FILE"
		kstatus=${PIPESTATUS[0]}
		set -e
		if [[ -n "$APPLY" ]]; then
			kubectl_bin=$(command -v kubectl || true)
			if [[ -z "$kubectl_bin" ]]; then
				echo "ERROR: kubectl not found in PATH" >&2
				exit 3
			fi
			"$kubectl_bin" apply -f "$OUTPUT_FILE"
			astatus=$?
			# prefer kustomize status if non-zero, otherwise kubectl status
			if [[ $kstatus -ne 0 ]]; then
				exit $kstatus
			else
				exit $astatus
			fi
		fi
		exit $kstatus
	else
		if [[ -n "$APPLY" ]]; then
			kubectl_bin=$(command -v kubectl || true)
			if [[ -z "$kubectl_bin" ]]; then
				echo "ERROR: kubectl not found in PATH" >&2
				exit 3
			fi
			set +e
			"$KUSTOMIZE_BIN" "${ARGS[@]}" | "$kubectl_bin" apply -f -
			kstatus=${PIPESTATUS[0]}
			astatus=${PIPESTATUS[1]}
			set -e
			if [[ $kstatus -ne 0 ]]; then
				exit $kstatus
			else
				exit $astatus
			fi
		else
			exec "$KUSTOMIZE_BIN" "${ARGS[@]}"
		fi
	fi
fi

# Default flags for kustomize build
DEFAULT_FLAGS=(build --enable-helm --load-restrictor LoadRestrictionsNone)

if [[ "${KUSTB_DEBUG:-0}" != "0" ]]; then
	echo "Running: $KUSTOMIZE_BIN ${DEFAULT_FLAGS[*]} $*" >&2
fi

# Parse args for -o/--output for the default invocation
USER_ARGS=("$@")
OUTPUT_FILE=""
APPLY=""
FILTERED_ARGS=()
i=0
while [ $i -lt ${#USER_ARGS[@]} ]; do
	a="${USER_ARGS[$i]}"
	case "$a" in
		-o)
			next=$((i+1))
			if [ $next -ge ${#USER_ARGS[@]} ]; then
				echo "ERROR: -o requires an argument" >&2
				exit 2
			fi
			OUTPUT_FILE="${USER_ARGS[$next]}"
			i=$((i+2)) ;;
		-o*)
			OUTPUT_FILE="${a#-o}"
			i=$((i+1)) ;;
		--output)
			next=$((i+1))
			if [ $next -ge ${#USER_ARGS[@]} ]; then
				echo "ERROR: --output requires an argument" >&2
				exit 2
			fi
			OUTPUT_FILE="${USER_ARGS[$next]}"
			i=$((i+2)) ;;
		--output=*)
			OUTPUT_FILE="${a#--output=}"
			i=$((i+1)) ;;
		--apply|-apl)
			APPLY=1
			i=$((i+1)) ;;
		*)
			FILTERED_ARGS+=("$a")
			i=$((i+1)) ;;
	esac
done

KUSTOMIZE_ARGS=("${DEFAULT_FLAGS[@]}" "${FILTERED_ARGS[@]}")

if [[ -n "$OUTPUT_FILE" ]]; then
	set +e
	"$KUSTOMIZE_BIN" "${KUSTOMIZE_ARGS[@]}" | tee "$OUTPUT_FILE"
	kstatus=${PIPESTATUS[0]}
	set -e
	if [[ -n "$APPLY" ]]; then
		kubectl_bin=$(command -v kubectl || true)
		if [[ -z "$kubectl_bin" ]]; then
			echo "ERROR: kubectl not found in PATH" >&2
			exit 3
		fi
		"$kubectl_bin" apply -f "$OUTPUT_FILE"
		astatus=$?
		if [[ $kstatus -ne 0 ]]; then
			exit $kstatus
		else
			exit $astatus
		fi
	fi
	exit $kstatus
else
	if [[ -n "$APPLY" ]]; then
		kubectl_bin=$(command -v kubectl || true)
		if [[ -z "$kubectl_bin" ]]; then
			echo "ERROR: kubectl not found in PATH" >&2
			exit 3
		fi
		set +e
		"$KUSTOMIZE_BIN" "${KUSTOMIZE_ARGS[@]}" | "$kubectl_bin" apply -f -
		kstatus=${PIPESTATUS[0]}
		astatus=${PIPESTATUS[1]}
		set -e
		if [[ $kstatus -ne 0 ]]; then
			exit $kstatus
		else
			exit $astatus
		fi
	else
		exec "$KUSTOMIZE_BIN" "${KUSTOMIZE_ARGS[@]}"
	fi
fi